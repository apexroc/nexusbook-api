# 公式字段

<cite>
**本文档引用的文件**
- [field-types.md](file://docs-src/references/field-types.md)
- [constants.tsp](file://api/shared/constants.tsp)
- [metadata.tsp](file://api/document/core/metadata.tsp)
- [data.tsp](file://api/document/core/data.tsp)
- [Doc.md](file://api/Doc.md)
- [document-model.md](file://docs-src/guides/document-model.md)
</cite>

## 目录
1. [简介](#简介)
2. [表达式语法](#表达式语法)
3. [运算符支持](#运算符支持)
4. [内置函数](#内置函数)
5. [字段引用机制](#字段引用机制)
6. [业务场景示例](#业务场景示例)
7. [服务端解析与执行](#服务端解析与执行)
8. [重新计算机制](#重新计算机制)
9. [安全性控制](#安全性控制)
10. [错误处理策略](#错误处理策略)
11. [结论](#结论)

## 简介
公式字段是NexusBook.AI平台中一种强大的计算型字段类型，允许用户通过表达式对数据进行动态计算。该功能支持丰富的运算符和内置函数，能够实现复杂的业务逻辑自动化。公式字段在数据变更时会自动触发重新计算，确保数据的实时性和准确性。本文档将深入讲解公式字段的各项功能特性、实现机制和最佳实践。

**本节来源**
- [field-types.md](file://docs-src/references/field-types.md)

## 表达式语法
公式字段的表达式采用类JavaScript语法，支持变量引用、运算符和函数调用。表达式以字符串形式存储在字段配置中，由服务端解析引擎执行。表达式中的字段引用使用字段ID作为变量名，系统会自动将这些引用解析为对应字段的实际值。

```json
{
  "type": "formula",
  "formula": "quantity * unitPrice"
}
```

**本节来源**
- [metadata.tsp](file://api/document/core/metadata.tsp#L93-L94)
- [field-types.md](file://docs-src/references/field-types.md#L357-L361)

## 运算符支持
公式字段支持三类基本运算符：算术运算符、比较运算符和逻辑运算符。

### 算术运算符
支持基本的数学运算：
- `+`：加法
- `-`：减法
- `*`：乘法
- `/`：除法
- `%`：取模

### 比较运算符
用于比较两个值的关系：
- `>`：大于
- `<`：小于
- `>=`：大于等于
- `<=`：小于等于
- `==`：等于
- `!=`：不等于

### 逻辑运算符
用于布尔逻辑运算：
- `&&`：逻辑与
- `||`：逻辑或
- `!`：逻辑非

**本节来源**
- [field-types.md](file://docs-src/references/field-types.md#L364-L367)

## 内置函数
公式字段提供了一系列内置函数，涵盖数学计算、条件判断和数值处理等场景。

### 数学函数
- `SUM()`：计算一组数值的总和
- `AVG()`：计算一组数值的平均值
- `ROUND()`：对数值进行四舍五入

### 条件函数
- `IF(condition, trueValue, falseValue)`：根据条件返回不同的值

这些函数可以直接在表达式中调用，参数可以是常量、字段引用或其他表达式。

**本节来源**
- [field-types.md](file://docs-src/references/field-types.md#L368)

## 字段引用机制
公式字段能够引用同一数据行内的其他字段值进行计算。引用时使用字段的ID作为变量名，系统会自动解析这些引用并获取对应字段的当前值。这种机制使得公式能够基于相关数据进行动态计算，实现数据间的联动。

例如，在采购订单场景中，"小计"字段可以通过引用"数量"和"单价"字段来计算："quantity * unitPrice"。

**本节来源**
- [metadata.tsp](file://api/document/core/metadata.tsp#L93-L94)
- [Doc.md](file://api/Doc.md#L670-L675)

## 业务场景示例
### 采购订单金额计算
在采购订单管理中，每行产品需要计算小计金额。通过公式字段，可以自动完成这一计算：

```json
{
  "id": "total",
  "name": "小计",
  "type": "number"
},
{
  "id": "quantity",
  "name": "数量",
  "type": "number"
},
{
  "id": "price",
  "name": "单价",
  "type": "number"
},
{
  "id": "subtotal",
  "name": "小计",
  "type": "formula",
  "formula": "quantity * price"
}
```

当用户输入数量和单价后，小计字段会自动计算并显示结果。

### 发票税额计算
在发票管理中，税额可以根据金额和税率自动计算：

```json
{
  "type": "formula",
  "formula": "amount * taxRate"
}
```

**本节来源**
- [Doc.md](file://api/Doc.md#L670-L686)
- [document-model.md](file://docs-src/guides/document-model.md#L896-L900)

## 服务端解析与执行
公式字段的解析和执行完全在服务端完成，确保了计算的安全性和一致性。当需要计算公式字段的值时，系统会启动表达式解析引擎，该引擎负责语法分析、变量解析和表达式求值。

解析过程包括：
1. 词法分析：将表达式字符串分解为标记（tokens）
2. 语法分析：构建抽象语法树（AST）
3. 变量解析：将字段引用解析为实际数据
4. 表达式求值：遍历AST并计算最终结果

这种服务端执行模式避免了客户端计算可能带来的安全风险和不一致性。

**本节来源**
- [metadata.tsp](file://api/document/core/metadata.tsp#L54-L64)
- [data.tsp](file://api/document/core/data.tsp#L71-L125)

## 重新计算机制
公式字段采用事件驱动的重新计算机制。当公式所依赖的任何字段值发生变化时，系统会自动触发重新计算流程。

计算触发条件包括：
- 直接修改依赖字段的值
- 通过批量更新操作修改数据
- 从关联记录中获取的新值

重新计算在数据提交时同步执行，确保所有公式字段的值都是最新的。这种机制保证了数据的一致性和实时性，用户无需手动刷新或重新计算。

**本节来源**
- [data.tsp](file://api/document/core/data.tsp#L71-L125)
- [Doc.md](file://api/Doc.md#L610-L648)

## 安全性控制
为防止表达式注入等安全风险，系统实施了严格的表达式验证和沙箱执行机制。

安全控制措施包括：
- 表达式语法验证：确保表达式符合预定义的语法规则
- 白名单函数限制：只允许调用预定义的安全函数
- 沙箱执行环境：在隔离环境中执行表达式，限制系统访问权限
- 资源使用限制：防止无限循环或资源耗尽攻击

这些安全措施确保了公式字段功能既强大又安全，不会对系统稳定性造成威胁。

**本节来源**
- [metadata.tsp](file://api/document/core/metadata.tsp#L99-L105)
- [constants.tsp](file://api/shared/constants.tsp#L242-L246)

## 错误处理策略
系统提供了完善的错误处理机制，确保在表达式无效或运行时出现异常时能够提供清晰的反馈。

错误处理包括：
- 语法错误检测：在保存公式时验证语法正确性
- 运行时异常捕获：在计算过程中捕获并处理异常
- 错误信息反馈：向用户提供具体的错误原因和位置
- 安全默认值：在计算失败时返回安全的默认值而非错误

当公式存在错误时，系统会标记该字段并提供详细的错误信息，帮助用户快速定位和修复问题。

**本节来源**
- [metadata.tsp](file://api/document/core/metadata.tsp#L99-L105)
- [field-types.md](file://docs-src/references/field-types.md)

## 结论
公式字段是NexusBook.AI平台中一个功能强大且安全可靠的数据计算工具。通过支持丰富的表达式语法、运算符和内置函数，它能够满足各种复杂的业务计算需求。字段引用机制和自动重新计算确保了数据的动态联动和实时性。服务端解析执行和严格的安全控制保证了系统的稳定性和安全性。结合完善的错误处理策略，公式字段为用户提供了高效、可靠的数据自动化解决方案。