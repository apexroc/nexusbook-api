name: Sync Repowiki to GitHub Wiki

on:
  push:
    branches: [ main ]
    paths:
      - '.qoder/repowiki/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare wiki files
        shell: bash
        run: |
          set -e
          mkdir -p sync-wiki
          
          # 源目录
          SOURCE_DIR=".qoder/repowiki/zh/content"
          
          # 首页：项目概述
          if [ -f "$SOURCE_DIR/项目概述.md" ]; then
            cp "$SOURCE_DIR/项目概述.md" sync-wiki/Home.md
          else
            echo "# NexusBook API Wiki" > sync-wiki/Home.md
          fi
          
          # 复制顶层文档
          for f in "$SOURCE_DIR"/*.md; do
            [ -e "$f" ] || continue
            filename=$(basename "$f")
            # 跳过首页（已处理为 Home.md）
            if [ "$filename" != "项目概述.md" ]; then
              cp "$f" "sync-wiki/$filename"
            fi
          done
          
          # 复制子目录（保留结构）
          for dir in "$SOURCE_DIR"/*/; do
            [ -d "$dir" ] || continue
            dirname=$(basename "$dir")
            mkdir -p "sync-wiki/$dirname"
            cp -r "$dir"*.md "sync-wiki/$dirname/" 2>/dev/null || true
          done
          
          # 生成侧边栏
          cat > sync-wiki/_Sidebar.md <<'SIDEBAR'
## NexusBook API 文档

### 开始使用
- [[Home|项目概述]]
- [[快速开始]]
- [[认证与授权]]

### 核心架构
- [[核心架构/文档模型]]
- [[核心架构/协作与工作流]]
- [[核心架构/数据操作]]
- [[核心架构/计费与租户管理]]

### 文档模型
- [[文档模型/元数据管理]]
- [[文档模型/数据行管理]]
- [[文档模型/文档属性管理]]
- [[文档模型/视图配置]]

### 协作与工作流
- [[协作与工作流/审批流程]]
- [[协作与工作流/变更请求]]
- [[协作与工作流/修订历史]]
- [[协作与工作流/评论系统]]

### 数据操作
- [[数据操作/CRUD操作]]
- [[数据操作/批量更新]]
- [[数据操作/查询与聚合]]

### 扩展与集成
- [[扩展与集成]]

### 计费与租户管理
- [[计费与租户管理/计费模块]]
- [[计费与租户管理/租户管理]]

### API 参考
- [[API参考]]

### 开发与部署
- [[开发与部署]]
- [[故障排除与最佳实践]]
SIDEBAR

      - name: Clone wiki repository
        shell: bash
        run: |
          set -e
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
          git clone "$WIKI_URL" wiki || {
            echo "Wiki not initialized. Creating initial commit..."
            mkdir wiki
            cd wiki
            git init
            git remote add origin "$WIKI_URL"
          }
          
          # 清空并复制新内容
          cd wiki
          rm -rf * .??* 2>/dev/null || true
          cp -r ../sync-wiki/* .

      - name: Commit and push to wiki
        shell: bash
        run: |
          set -e
          cd wiki
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(wiki): sync from .qoder/repowiki at $GITHUB_SHA"
            git push -u origin master || git push -u origin main
          fi
