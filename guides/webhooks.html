<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook ä½¿ç”¨æŒ‡å— - NexusBook API æ–‡æ¡£</title>
    <link rel="stylesheet" href="/nexusbook-api/styles/main.css?v=${Date.now()}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/common.min.js"></script>
    <script>
      if (window.hljs) { hljs.highlightAll(); }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
      mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</head>
<body class="has-sidebar">
    <nav class="sidebar">
<div class="sidebar-header">
<a href="/nexusbook-api/index.html" class="sidebar-logo">NexusBook API</a>
</div>
<div class="sidebar-content">
<div class="sidebar-group expanded">
<div class="sidebar-group-title">å¼€å§‹ä½¿ç”¨</div>
<ul class="sidebar-items">
<li class="sidebar-item ">
<a href="/nexusbook-api/index.html">æ¦‚è§ˆ</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/getting-started.html">å¿«é€Ÿå¼€å§‹</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/authentication.html">è®¤è¯æˆæƒ</a>
</li>
</ul>
</div>
<div class="sidebar-group expanded">
<div class="sidebar-group-title">æ ¸å¿ƒæ¦‚å¿µ</div>
<ul class="sidebar-items">
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/document-model.html">æ–‡æ¡£æ¨¡å‹</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/data-operations.html">æ•°æ®æ“ä½œ</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/webhooks.html">Webhook äº‹ä»¶</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/realtime-collaboration.html">å®æ—¶ååŒ</a>
</li>
</ul>
</div>
<div class="sidebar-group expanded">
<div class="sidebar-group-title">API å‚è€ƒ</div>
<ul class="sidebar-items">
<li class="sidebar-item ">
<a href="/nexusbook-api/api/index.html">API ç«¯ç‚¹</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/references/field-types.html">å­—æ®µç±»å‹</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/references/error-codes.html">é”™è¯¯ç </a>
</li>
</ul>
</div>
<div class="sidebar-group ">
<div class="sidebar-group-title">å¼€å‘æŒ‡å—</div>
<ul class="sidebar-items">
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/development.html">å¼€å‘ç¯å¢ƒ</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/architecture.html">æ¶æ„è®¾è®¡</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/best-practices.html">æœ€ä½³å®è·µ</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/guides/examples.html">å®Œæ•´ç¤ºä¾‹</a>
</li>
</ul>
</div>
<div class="sidebar-group ">
<div class="sidebar-group-title">å…¶ä»–èµ„æº</div>
<ul class="sidebar-items">
<li class="sidebar-item ">
<a href="/nexusbook-api/references/i18n.html">å›½é™…åŒ–</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/references/changelog.html">æ›´æ–°æ—¥å¿—</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/CONTRIBUTING.html">è´¡çŒ®æŒ‡å—</a>
</li>
<li class="sidebar-item ">
<a href="/nexusbook-api/TROUBLESHOOTING.html">é—®é¢˜æ’æŸ¥</a>
</li>
</ul>
</div>
</div>
</nav>

    
    <div class="main-wrapper">
        <header class="header">
            <div class="container">
                <h1 class="logo"><a href="/nexusbook-api/index.html">NexusBook API</a></h1>
                <nav class="nav">
                    <a href="/nexusbook-api/index.html">é¦–é¡µ</a>
                    <a href="/nexusbook-api/api/" >API å‚è€ƒ</a>
                    <a href="/nexusbook-api/guides/getting-started.html" class="active">å¼€å‘æŒ‡å—</a>
                    <a href="/nexusbook-api/advanced/README.html" >é«˜çº§æ‰‹å†Œ</a>
                    <a href="/nexusbook-api/references/error-codes.html" >å‚è€ƒæ–‡æ¡£</a>
                    <a href="https://github.com/NexusBook/nexusbook-api" target="_blank">GitHub</a>
                </nav>
            </div>
        </header>

        <main class="main content-page">
            <div class="container">
                <article class="content">
                    <h1>Webhook ä½¿ç”¨æŒ‡å—</h1>
<h2>æ¦‚è¿°</h2>
<div class="mermaid">flowchart LR
  Event["æ–‡æ¡£äº‹ä»¶"] --> Delivery["Webhook æŠ•é€’"]
  Delivery --> Receiver["æ¥æ”¶ç«¯"]
  Receiver --> Verify["ç­¾åéªŒè¯"]
  Verify --> Queue["å…¥é˜Ÿ/å¹‚ç­‰æ ¡éªŒ"]
  Queue --> Process["ä¸šåŠ¡å¤„ç†"]
  Process --> Resp["å¿«é€Ÿå“åº” 200"]</div>
<p>Webhook æä¾›äº‹ä»¶é©±åŠ¨çš„é€šçŸ¥æœºåˆ¶ï¼Œå½“æ–‡æ¡£å‘ç”Ÿç‰¹å®šå˜æ›´æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å‘æ‚¨é…ç½®çš„ URL å‘é€ HTTP POST è¯·æ±‚ã€‚</p>
<h2>æ”¯æŒçš„äº‹ä»¶ç±»å‹</h2>
<h3>1. Request ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>request_created</code></td>
<td>åˆ›å»ºå˜æ›´è¯·æ±‚</td>
<td>ç”¨æˆ·åˆ›å»ºæ–°çš„å˜æ›´è¯·æ±‚æ—¶</td>
</tr>
<tr>
<td><code>request_merged</code></td>
<td>è¯·æ±‚å·²åˆå¹¶</td>
<td>å˜æ›´è¯·æ±‚è¢«åˆå¹¶åˆ°ä¸»æ–‡æ¡£æ—¶</td>
</tr>
<tr>
<td><code>request_closed</code></td>
<td>è¯·æ±‚å·²å…³é—­</td>
<td>å˜æ›´è¯·æ±‚è¢«å…³é—­ï¼ˆæ‹’ç»ï¼‰æ—¶</td>
</tr>
<tr>
<td><code>request_reopened</code></td>
<td>è¯·æ±‚é‡æ–°æ‰“å¼€</td>
<td>å·²å…³é—­çš„è¯·æ±‚è¢«é‡æ–°æ‰“å¼€æ—¶</td>
</tr>
</tbody></table>
<p><strong>è½½è·ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-json">{
  &quot;event&quot;: &quot;request_merged&quot;,
  &quot;timestamp&quot;: &quot;2024-12-01T10:00:00Z&quot;,
  &quot;webhookId&quot;: &quot;webhook-123&quot;,
  &quot;deliveryId&quot;: &quot;delivery-456&quot;,
  &quot;docType&quot;: &quot;product&quot;,
  &quot;docId&quot;: &quot;123&quot;,
  &quot;triggeredBy&quot;: &quot;user-789&quot;,
  &quot;payload&quot;: {
    &quot;requestId&quot;: &quot;req-001&quot;,
    &quot;title&quot;: &quot;æ›´æ–°äº§å“ä»·æ ¼&quot;,
    &quot;author&quot;: &quot;user-789&quot;,
    &quot;mergedBy&quot;: &quot;user-admin&quot;,
    &quot;mergedAt&quot;: &quot;2024-12-01T10:00:00Z&quot;,
    &quot;revisionId&quot;: &quot;rev-100&quot;,
    &quot;changesApplied&quot;: 5
  }
}
</code></pre>
<h3>2. Approval ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>approval_started</code></td>
<td>å®¡æ‰¹æµç¨‹å¼€å§‹</td>
<td>å‘èµ·å®¡æ‰¹æµç¨‹æ—¶</td>
</tr>
<tr>
<td><code>approval_approved</code></td>
<td>å®¡æ‰¹é€šè¿‡</td>
<td>å®¡æ‰¹æµç¨‹å…¨éƒ¨é€šè¿‡æ—¶</td>
</tr>
<tr>
<td><code>approval_rejected</code></td>
<td>å®¡æ‰¹æ‹’ç»</td>
<td>å®¡æ‰¹è¢«æ‹’ç»æ—¶</td>
</tr>
<tr>
<td><code>approval_canceled</code></td>
<td>å®¡æ‰¹å–æ¶ˆ</td>
<td>å®¡æ‰¹æµç¨‹è¢«å–æ¶ˆæ—¶</td>
</tr>
<tr>
<td><code>approval_node_completed</code></td>
<td>å®¡æ‰¹èŠ‚ç‚¹å®Œæˆ</td>
<td>å•ä¸ªå®¡æ‰¹èŠ‚ç‚¹å®Œæˆæ—¶</td>
</tr>
</tbody></table>
<p><strong>è½½è·ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-json">{
  &quot;event&quot;: &quot;approval_approved&quot;,
  &quot;timestamp&quot;: &quot;2024-12-01T11:00:00Z&quot;,
  &quot;webhookId&quot;: &quot;webhook-123&quot;,
  &quot;deliveryId&quot;: &quot;delivery-457&quot;,
  &quot;docType&quot;: &quot;product&quot;,
  &quot;docId&quot;: &quot;123&quot;,
  &quot;triggeredBy&quot;: &quot;user-approver&quot;,
  &quot;payload&quot;: {
    &quot;instanceId&quot;: &quot;approval-001&quot;,
    &quot;status&quot;: &quot;approved&quot;,
    &quot;currentNode&quot;: &quot;final&quot;,
    &quot;approver&quot;: &quot;user-approver&quot;,
    &quot;decision&quot;: &quot;approve&quot;,
    &quot;comment&quot;: &quot;æ‰¹å‡†é€šè¿‡&quot;,
    &quot;completedAt&quot;: &quot;2024-12-01T11:00:00Z&quot;
  }
}
</code></pre>
<h3>3. Comment ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>comment_created</code></td>
<td>åˆ›å»ºè¯„è®º</td>
<td>ç”¨æˆ·åˆ›å»ºæ–°è¯„è®ºæ—¶</td>
</tr>
<tr>
<td><code>comment_updated</code></td>
<td>æ›´æ–°è¯„è®º</td>
<td>è¯„è®ºå†…å®¹è¢«ä¿®æ”¹æ—¶</td>
</tr>
<tr>
<td><code>comment_deleted</code></td>
<td>åˆ é™¤è¯„è®º</td>
<td>è¯„è®ºè¢«åˆ é™¤æ—¶</td>
</tr>
<tr>
<td><code>comment_resolved</code></td>
<td>è¯„è®ºå·²è§£å†³</td>
<td>è¯„è®ºè¢«æ ‡è®°ä¸ºå·²è§£å†³æ—¶</td>
</tr>
<tr>
<td><code>comment_mentioned</code></td>
<td>ç”¨æˆ·è¢« @æåŠ</td>
<td>è¯„è®ºä¸­ @æåŠç”¨æˆ·æ—¶</td>
</tr>
</tbody></table>
<p><strong>è½½è·ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-json">{
  &quot;event&quot;: &quot;comment_created&quot;,
  &quot;timestamp&quot;: &quot;2024-12-01T12:00:00Z&quot;,
  &quot;webhookId&quot;: &quot;webhook-123&quot;,
  &quot;deliveryId&quot;: &quot;delivery-458&quot;,
  &quot;docType&quot;: &quot;product&quot;,
  &quot;docId&quot;: &quot;123&quot;,
  &quot;triggeredBy&quot;: &quot;user-001&quot;,
  &quot;payload&quot;: {
    &quot;commentId&quot;: &quot;comment-001&quot;,
    &quot;target&quot;: {
      &quot;scope&quot;: &quot;cell&quot;,
      &quot;rowId&quot;: &quot;row-123&quot;,
      &quot;fieldId&quot;: &quot;price&quot;
    },
    &quot;content&quot;: &quot;@å¼ ä¸‰ è¿™ä¸ªä»·æ ¼éœ€è¦ç¡®è®¤&quot;,
    &quot;mentions&quot;: [
      {
        &quot;id&quot;: &quot;user-002&quot;,
        &quot;displayName&quot;: &quot;å¼ ä¸‰&quot;
      }
    ],
    &quot;createdBy&quot;: &quot;user-001&quot;,
    &quot;createdAt&quot;: &quot;2024-12-01T12:00:00Z&quot;
  }
}
</code></pre>
<h3>4. Metadata ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>metadata_updated</code></td>
<td>å…ƒæ•°æ®æ›´æ–°</td>
<td>å…ƒæ•°æ®æ•´ä½“æ›´æ–°æ—¶</td>
</tr>
<tr>
<td><code>metadata_field_added</code></td>
<td>æ·»åŠ å­—æ®µ</td>
<td>æ–°å¢å­—æ®µæ—¶</td>
</tr>
<tr>
<td><code>metadata_field_updated</code></td>
<td>æ›´æ–°å­—æ®µ</td>
<td>ä¿®æ”¹å­—æ®µé…ç½®æ—¶</td>
</tr>
<tr>
<td><code>metadata_field_deleted</code></td>
<td>åˆ é™¤å­—æ®µ</td>
<td>åˆ é™¤å­—æ®µæ—¶</td>
</tr>
</tbody></table>
<p><strong>è½½è·ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-json">{
  &quot;event&quot;: &quot;metadata_field_added&quot;,
  &quot;timestamp&quot;: &quot;2024-12-01T13:00:00Z&quot;,
  &quot;webhookId&quot;: &quot;webhook-123&quot;,
  &quot;deliveryId&quot;: &quot;delivery-459&quot;,
  &quot;docType&quot;: &quot;product&quot;,
  &quot;docId&quot;: &quot;123&quot;,
  &quot;triggeredBy&quot;: &quot;user-admin&quot;,
  &quot;payload&quot;: {
    &quot;field&quot;: {
      &quot;id&quot;: &quot;field-new&quot;,
      &quot;name&quot;: &quot;åº“å­˜æ•°é‡&quot;,
      &quot;type&quot;: &quot;number&quot;,
      &quot;required&quot;: true,
      &quot;defaultValue&quot;: 0
    },
    &quot;updatedBy&quot;: &quot;user-admin&quot;,
    &quot;updatedAt&quot;: &quot;2024-12-01T13:00:00Z&quot;
  }
}
</code></pre>
<h3>5. View ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>view_created</code></td>
<td>åˆ›å»ºè§†å›¾</td>
<td>åˆ›å»ºæ–°è§†å›¾æ—¶</td>
</tr>
<tr>
<td><code>view_updated</code></td>
<td>æ›´æ–°è§†å›¾</td>
<td>ä¿®æ”¹è§†å›¾é…ç½®æ—¶</td>
</tr>
<tr>
<td><code>view_deleted</code></td>
<td>åˆ é™¤è§†å›¾</td>
<td>åˆ é™¤è§†å›¾æ—¶</td>
</tr>
<tr>
<td><code>view_default_changed</code></td>
<td>é»˜è®¤è§†å›¾å˜æ›´</td>
<td>æ›´æ”¹é»˜è®¤è§†å›¾æ—¶</td>
</tr>
</tbody></table>
<p><strong>è½½è·ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-json">{
  &quot;event&quot;: &quot;view_created&quot;,
  &quot;timestamp&quot;: &quot;2024-12-01T14:00:00Z&quot;,
  &quot;webhookId&quot;: &quot;webhook-123&quot;,
  &quot;deliveryId&quot;: &quot;delivery-460&quot;,
  &quot;docType&quot;: &quot;product&quot;,
  &quot;docId&quot;: &quot;123&quot;,
  &quot;triggeredBy&quot;: &quot;user-001&quot;,
  &quot;payload&quot;: {
    &quot;viewId&quot;: &quot;view-new&quot;,
    &quot;name&quot;: &quot;ä½åº“å­˜äº§å“&quot;,
    &quot;type&quot;: &quot;table&quot;,
    &quot;filters&quot;: {
      &quot;logic&quot;: &quot;and&quot;,
      &quot;conditions&quot;: [
        {
          &quot;field&quot;: &quot;stock&quot;,
          &quot;operator&quot;: &quot;range&quot;,
          &quot;rangeStart&quot;: 0,
          &quot;rangeEnd&quot;: 10
        }
      ]
    },
    &quot;createdBy&quot;: &quot;user-001&quot;,
    &quot;createdAt&quot;: &quot;2024-12-01T14:00:00Z&quot;
  }
}
</code></pre>
<h3>6. Data ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>data_row_created</code></td>
<td>åˆ›å»ºæ•°æ®è¡Œ</td>
<td>æ–°å¢æ•°æ®è¡Œæ—¶</td>
</tr>
<tr>
<td><code>data_row_updated</code></td>
<td>æ›´æ–°æ•°æ®è¡Œ</td>
<td>ä¿®æ”¹æ•°æ®è¡Œæ—¶</td>
</tr>
<tr>
<td><code>data_row_deleted</code></td>
<td>åˆ é™¤æ•°æ®è¡Œ</td>
<td>åˆ é™¤æ•°æ®è¡Œæ—¶</td>
</tr>
<tr>
<td><code>data_bulk_operation</code></td>
<td>æ‰¹é‡æ“ä½œ</td>
<td>æ‰¹é‡åˆ›å»º/æ›´æ–°/åˆ é™¤æ—¶</td>
</tr>
</tbody></table>
<h3>7. Revision ç›¸å…³äº‹ä»¶</h3>
<table>
<thead>
<tr>
<th>äº‹ä»¶ç±»å‹</th>
<th>è¯´æ˜</th>
<th>è§¦å‘æ—¶æœº</th>
</tr>
</thead>
<tbody><tr>
<td><code>revision_created</code></td>
<td>åˆ›å»ºä¿®è®¢</td>
<td>ç”Ÿæˆæ–°ä¿®è®¢è®°å½•æ—¶</td>
</tr>
<tr>
<td><code>revision_reverted</code></td>
<td>ä¿®è®¢å›æ»š</td>
<td>å›æ»šåˆ°å†å²ç‰ˆæœ¬æ—¶</td>
</tr>
</tbody></table>
<h2>å¿«é€Ÿå¼€å§‹</h2>
<h3>1. åˆ›å»º Webhook</h3>
<pre><code class="language-bash">curl -X POST &#39;https://open.nexusbook.app/api/v1/webhooks&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39; \
  -H &#39;Content-Type: application/json&#39; \
  -d &#39;{
    &quot;name&quot;: &quot;äº§å“å˜æ›´é€šçŸ¥&quot;,
    &quot;description&quot;: &quot;ç›‘æ§äº§å“æ–‡æ¡£çš„æ‰€æœ‰å˜æ›´&quot;,
    &quot;url&quot;: &quot;https://your-domain.com/webhooks/nexusbook&quot;,
    &quot;events&quot;: [
      &quot;request_merged&quot;,
      &quot;approval_approved&quot;,
      &quot;comment_created&quot;,
      &quot;metadata_field_added&quot;,
      &quot;view_created&quot;
    ],
    &quot;filters&quot;: {
      &quot;docTypes&quot;: [&quot;product&quot;],
      &quot;docIds&quot;: [&quot;123&quot;, &quot;456&quot;]
    },
    &quot;timeout&quot;: 30,
    &quot;maxRetries&quot;: 3,
    &quot;retryInterval&quot;: 60
  }&#39;
</code></pre>
<h3>2. æ¥æ”¶ Webhook äº‹ä»¶</h3>
<p><strong>Node.js ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-javascript">const express = require(&#39;express&#39;);
const crypto = require(&#39;crypto&#39;);

const app = express();
app.use(express.json());

// Webhook å¯†é’¥ï¼ˆä» NexusBook è·å–ï¼‰
const WEBHOOK_SECRET = &#39;your_webhook_secret&#39;;

// éªŒè¯ç­¾å
function verifySignature(payload, signature) {
  const hmac = crypto.createHmac(&#39;sha256&#39;, WEBHOOK_SECRET);
  const digest = &#39;sha256=&#39; + hmac.update(payload).digest(&#39;hex&#39;);
  return crypto.timingSafeEqual(
    Buffer.from(signature),
    Buffer.from(digest)
  );
}

app.post(&#39;/webhooks/nexusbook&#39;, (req, res) =&gt; {
  const signature = req.headers[&#39;x-webhook-signature&#39;];
  const payload = JSON.stringify(req.body);

  // éªŒè¯ç­¾å
  if (!verifySignature(payload, signature)) {
    return res.status(401).send(&#39;Invalid signature&#39;);
  }

  const event = req.body;
  console.log(&#39;Received event:&#39;, event.event);

  // å¤„ç†ä¸åŒç±»å‹çš„äº‹ä»¶
  switch (event.event) {
    case &#39;request_merged&#39;:
      handleRequestMerged(event);
      break;
    case &#39;approval_approved&#39;:
      handleApprovalApproved(event);
      break;
    case &#39;comment_created&#39;:
      handleCommentCreated(event);
      break;
    // ... å…¶ä»–äº‹ä»¶ç±»å‹
  }

  // å¿«é€Ÿå“åº” 200ï¼Œé¿å…è¶…æ—¶
  res.status(200).send(&#39;OK&#39;);
});

function handleRequestMerged(event) {
  const { requestId, title, revisionId } = event.payload;
  console.log(`Request ${requestId} merged: ${title}`);
  // å‘é€é€šçŸ¥ã€æ›´æ–°æ•°æ®åº“ç­‰
}

function handleApprovalApproved(event) {
  const { instanceId, approver } = event.payload;
  console.log(`Approval ${instanceId} approved by ${approver}`);
  // è§¦å‘åç»­æµç¨‹
}

function handleCommentCreated(event) {
  const { commentId, content, mentions } = event.payload;
  console.log(`New comment: ${content}`);
  // å‘é€é‚®ä»¶é€šçŸ¥è¢« @æåŠçš„ç”¨æˆ·
  mentions?.forEach(user =&gt; {
    sendEmailNotification(user.email, content);
  });
}

app.listen(3000, () =&gt; {
  console.log(&#39;Webhook server listening on port 3000&#39;);
});
</code></pre>
<p><strong>Python ç¤ºä¾‹ï¼š</strong></p>
<pre><code class="language-python">from flask import Flask, request, jsonify
import hmac
import hashlib

app = Flask(__name__)

WEBHOOK_SECRET = &#39;your_webhook_secret&#39;

def verify_signature(payload, signature):
    mac = hmac.new(
        WEBHOOK_SECRET.encode(),
        payload.encode(),
        hashlib.sha256
    )
    expected = &#39;sha256=&#39; + mac.hexdigest()
    return hmac.compare_digest(expected, signature)

@app.route(&#39;/webhooks/nexusbook&#39;, methods=[&#39;POST&#39;])
def webhook():
    signature = request.headers.get(&#39;X-Webhook-Signature&#39;)
    payload = request.get_data(as_text=True)
    
    if not verify_signature(payload, signature):
        return jsonify({&#39;error&#39;: &#39;Invalid signature&#39;}), 401
    
    event = request.json
    event_type = event[&#39;event&#39;]
    
    if event_type == &#39;request_merged&#39;:
        handle_request_merged(event)
    elif event_type == &#39;approval_approved&#39;:
        handle_approval_approved(event)
    elif event_type == &#39;comment_created&#39;:
        handle_comment_created(event)
    
    return jsonify({&#39;status&#39;: &#39;ok&#39;}), 200

def handle_request_merged(event):
    request_id = event[&#39;payload&#39;][&#39;requestId&#39;]
    print(f&#39;Request {request_id} merged&#39;)

def handle_approval_approved(event):
    instance_id = event[&#39;payload&#39;][&#39;instanceId&#39;]
    print(f&#39;Approval {instance_id} approved&#39;)

def handle_comment_created(event):
    comment_id = event[&#39;payload&#39;][&#39;commentId&#39;]
    print(f&#39;Comment {comment_id} created&#39;)

if __name__ == &#39;__main__&#39;:
    app.run(port=3000)
</code></pre>
<h3>3. æµ‹è¯• Webhook</h3>
<pre><code class="language-bash"># å‘é€æµ‹è¯•äº‹ä»¶
curl -X POST &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/test&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39; \
  -H &#39;Content-Type: application/json&#39; \
  -d &#39;{
    &quot;event&quot;: &quot;request_merged&quot;,
    &quot;payload&quot;: {
      &quot;requestId&quot;: &quot;test-req&quot;,
      &quot;title&quot;: &quot;æµ‹è¯•è¯·æ±‚&quot;
    }
  }&#39;
</code></pre>
<h2>äº‹ä»¶è¿‡æ»¤</h2>
<h3>æŒ‰æ–‡æ¡£ç±»å‹è¿‡æ»¤</h3>
<pre><code class="language-json">{
  &quot;filters&quot;: {
    &quot;docTypes&quot;: [&quot;product&quot;, &quot;inventory&quot;]
  }
}
</code></pre>
<h3>æŒ‰æ–‡æ¡£ ID è¿‡æ»¤</h3>
<pre><code class="language-json">{
  &quot;filters&quot;: {
    &quot;docIds&quot;: [&quot;123&quot;, &quot;456&quot;, &quot;789&quot;]
  }
}
</code></pre>
<h3>æŒ‰ç”¨æˆ·è¿‡æ»¤</h3>
<pre><code class="language-json">{
  &quot;filters&quot;: {
    &quot;userIds&quot;: [&quot;user-001&quot;, &quot;user-002&quot;]
  }
}
</code></pre>
<h3>è‡ªå®šä¹‰æ¡ä»¶è¿‡æ»¤</h3>
<pre><code class="language-json">{
  &quot;filters&quot;: {
    &quot;conditions&quot;: [
      {
        &quot;path&quot;: &quot;$.payload.status&quot;,
        &quot;operator&quot;: &quot;eq&quot;,
        &quot;value&quot;: &quot;urgent&quot;
      },
      {
        &quot;path&quot;: &quot;$.payload.amount&quot;,
        &quot;operator&quot;: &quot;range&quot;,
        &quot;value&quot;: [1000, 10000]
      }
    ]
  }
}
</code></pre>
<h2>å®‰å…¨æœ€ä½³å®è·µ</h2>
<h3>1. éªŒè¯ç­¾å</h3>
<p>å§‹ç»ˆéªŒè¯ <code>X-Webhook-Signature</code> å¤´ï¼Œç¡®ä¿è¯·æ±‚æ¥è‡ª NexusBookï¼š</p>
<pre><code class="language-javascript">const signature = req.headers[&#39;x-webhook-signature&#39;];
const isValid = verifySignature(payload, signature);
if (!isValid) {
  return res.status(401).send(&#39;Invalid signature&#39;);
}
</code></pre>
<h3>2. å¿«é€Ÿå“åº”</h3>
<p>åœ¨ 30 ç§’å†…å“åº” 200 çŠ¶æ€ç ï¼Œé¿å…è¶…æ—¶é‡è¯•ï¼š</p>
<pre><code class="language-javascript">app.post(&#39;/webhook&#39;, async (req, res) =&gt; {
  // ç«‹å³å“åº”
  res.status(200).send(&#39;OK&#39;);
  
  // å¼‚æ­¥å¤„ç†äº‹ä»¶
  processEventAsync(req.body);
});
</code></pre>
<h3>3. å¹‚ç­‰æ€§å¤„ç†</h3>
<p>ä½¿ç”¨ <code>deliveryId</code> ç¡®ä¿äº‹ä»¶åªå¤„ç†ä¸€æ¬¡ï¼š</p>
<pre><code class="language-javascript">const processedDeliveries = new Set();

function processEvent(event) {
  if (processedDeliveries.has(event.deliveryId)) {
    console.log(&#39;Event already processed&#39;);
    return;
  }
  
  // å¤„ç†äº‹ä»¶
  // ...
  
  processedDeliveries.add(event.deliveryId);
}
</code></pre>
<h3>4. é”™è¯¯å¤„ç†</h3>
<p>å¦¥å–„å¤„ç†é”™è¯¯ï¼Œé¿å…é¢‘ç¹å¤±è´¥å¯¼è‡´ Webhook è¢«ç¦ç”¨ï¼š</p>
<pre><code class="language-javascript">app.post(&#39;/webhook&#39;, async (req, res) =&gt; {
  try {
    await processEvent(req.body);
    res.status(200).send(&#39;OK&#39;);
  } catch (error) {
    console.error(&#39;Error processing webhook:&#39;, error);
    // è¿”å› 200 é¿å…é‡è¯•ï¼ˆå¦‚æœæ˜¯ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼‰
    res.status(200).send(&#39;Error logged&#39;);
  }
});
</code></pre>
<h2>ç®¡ç† Webhook</h2>
<h3>æŸ¥çœ‹æŠ•é€’å†å²</h3>
<pre><code class="language-bash">curl &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/deliveries&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39;
</code></pre>
<h3>æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯</h3>
<pre><code class="language-bash">curl &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/stats&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39;
</code></pre>
<h3>æš‚åœ Webhook</h3>
<pre><code class="language-bash">curl -X POST &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/pause&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39;
</code></pre>
<h3>æ¢å¤ Webhook</h3>
<pre><code class="language-bash">curl -X POST &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/resume&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39;
</code></pre>
<h3>é‡æ–°æŠ•é€’å¤±è´¥çš„äº‹ä»¶</h3>
<pre><code class="language-bash">curl -X POST &#39;https://open.nexusbook.app/api/v1/webhooks/webhook-123/deliveries/delivery-456/redeliver&#39; \
  -H &#39;Authorization: Bearer YOUR_TOKEN&#39;
</code></pre>
<h2>å¸¸è§é—®é¢˜</h2>
<h3>Q: Webhook ä¼šé‡è¯•å¤šå°‘æ¬¡ï¼Ÿ</h3>
<p>A: é»˜è®¤é‡è¯• 3 æ¬¡ï¼Œé—´éš” 60 ç§’ã€‚å¯ä»¥åœ¨åˆ›å»º Webhook æ—¶è‡ªå®šä¹‰ <code>maxRetries</code> å’Œ <code>retryInterval</code>ã€‚</p>
<h3>Q: å¦‚ä½•ç¡®ä¿äº‹ä»¶ä¸ä¼šä¸¢å¤±ï¼Ÿ</h3>
<p>A: ç³»ç»Ÿä¼šæŒä¹…åŒ–æ‰€æœ‰æŠ•é€’è®°å½•ï¼Œå³ä½¿ Webhook æš‚æ—¶å¤±è´¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŠ•é€’å†å²æŸ¥çœ‹å¹¶æ‰‹åŠ¨é‡æ–°æŠ•é€’ã€‚</p>
<h3>Q: å¯ä»¥æ¥æ”¶å†å²äº‹ä»¶å—ï¼Ÿ</h3>
<p>A: Webhook åªæ¨é€åˆ›å»ºåå‘ç”Ÿçš„æ–°äº‹ä»¶ã€‚å¦‚éœ€å†å²æ•°æ®ï¼Œè¯·ä½¿ç”¨ API æŸ¥è¯¢ã€‚</p>
<h3>Q: å¦‚ä½•è°ƒè¯• Webhookï¼Ÿ</h3>
<p>A: </p>
<ol>
<li>ä½¿ç”¨æµ‹è¯•ç«¯ç‚¹å‘é€æµ‹è¯•äº‹ä»¶</li>
<li>æŸ¥çœ‹æŠ•é€’å†å²å’Œè¯¦ç»†æ—¥å¿—</li>
<li>ä½¿ç”¨ webhook.site ç­‰å·¥å…·æ¥æ”¶å’ŒæŸ¥çœ‹è¯·æ±‚</li>
</ol>
<h3>Q: Webhook URL å¿…é¡»æ˜¯ HTTPS å—ï¼Ÿ</h3>
<p>A: ç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ä½¿ç”¨ HTTPSï¼Œç¡®ä¿æ•°æ®ä¼ è¾“å®‰å…¨ã€‚å¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨ HTTPã€‚</p>
<h2>ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</h2>
<h3>1. è‡ªåŠ¨é€šçŸ¥å›¢é˜Ÿ</h3>
<p>å½“é‡è¦å˜æ›´è¢«åˆå¹¶æ—¶ï¼Œè‡ªåŠ¨å‘é€ Slack/é’‰é’‰é€šçŸ¥ï¼š</p>
<pre><code class="language-javascript">function handleRequestMerged(event) {
  const { title, mergedBy } = event.payload;
  sendSlackNotification({
    channel: &#39;#product-updates&#39;,
    text: `ğŸ‰ ${mergedBy} åˆå¹¶äº†å˜æ›´: ${title}`
  });
}
</code></pre>
<h3>2. è§¦å‘ CI/CD æµç¨‹</h3>
<p>å…ƒæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨è§¦å‘éƒ¨ç½²ï¼š</p>
<pre><code class="language-javascript">function handleMetadataUpdated(event) {
  triggerCICD({
    pipeline: &#39;deploy-schema&#39;,
    params: {
      docType: event.docType,
      docId: event.docId
    }
  });
}
</code></pre>
<h3>3. åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿ</h3>
<p>æ•°æ®å˜æ›´æ—¶åŒæ­¥åˆ° ERP/CRM ç³»ç»Ÿï¼š</p>
<pre><code class="language-javascript">function handleDataRowUpdated(event) {
  const { rowId, values } = event.payload;
  syncToERP({
    id: rowId,
    data: values
  });
}
</code></pre>
<h3>4. å®¡è®¡æ—¥å¿—</h3>
<p>è®°å½•æ‰€æœ‰é‡è¦æ“ä½œåˆ°å®¡è®¡ç³»ç»Ÿï¼š</p>
<pre><code class="language-javascript">function handleAnyEvent(event) {
  auditLog.record({
    event: event.event,
    user: event.triggeredBy,
    timestamp: event.timestamp,
    details: event.payload
  });
}
</code></pre>
<h2>ä¸ SSE äº‹ä»¶æµçš„å¯¹æ¯”ä¸é€‰æ‹©</h2>
<ul>
<li><strong>Webhookï¼ˆæ¨é€ï¼‰</strong>ï¼šç”±æœåŠ¡å™¨å‘ä½ é…ç½®çš„ URL ä¸»åŠ¨å‘é€ HTTP POSTï¼›é€‚åˆè§¦å‘ä¸‹æ¸¸æµç¨‹ã€è·¨ç³»ç»Ÿé›†æˆã€ç¦»çº¿å¤„ç†ï¼›æ”¯æŒå¤±è´¥é‡è¯•ä¸æŠ•é€’å†å²ã€‚</li>
<li><strong>SSEï¼ˆæ‹‰å–åªè¯»æµï¼‰</strong>ï¼šå®¢æˆ·ç«¯ä¸ <code>GET /doc/{docType}/{docId}/events/stream</code> å»ºç«‹é•¿è¿æ¥ï¼ŒæŒç»­æ¥æ”¶åªè¯»äº‹ä»¶æµï¼›é€‚åˆçœ‹æ¿/ä»ªè¡¨ç›˜çš„è¿‘å®æ—¶æ›´æ–°ï¼›ç”±å®¢æˆ·ç«¯ç»´æŠ¤è¿æ¥ä¸æ–­çº¿é‡è¿ã€‚</li>
<li><strong>é€‰æ‹©å»ºè®®</strong>ï¼š<ul>
<li><strong>æœåŠ¡ç«¯åˆ°æœåŠ¡ç«¯é›†æˆ</strong>ã€éœ€å¯é æŠ•é€’ä¸é‡è¯• â†’ ä¼˜å…ˆ Webhookã€‚</li>
<li><strong>å‰ç«¯å®æ—¶å±•ç¤º</strong> æˆ– <strong>è½»é‡ç›‘å¬</strong> â†’ ä¼˜å…ˆ SSEã€‚</li>
<li>äºŒè€…å¯åŒæ—¶ä½¿ç”¨ï¼šWebhook é©±åŠ¨æµç¨‹ï¼ŒSSE æä¾›é¡µé¢å®æ—¶çŠ¶æ€ã€‚</li>
</ul>
</li>
</ul>
<h2>ç­¾åéªŒè¯ç»†èŠ‚ä¸é˜²é‡æ”¾</h2>
<ul>
<li><strong>ç­¾åç®—æ³•</strong>ï¼š<code>HMAC-SHA256(secret, timestamp + &#39;.&#39; + rawPayload)</code>ï¼›HTTP å¤´ï¼š<code>X-Webhook-Signature</code>ã€<code>X-Webhook-Timestamp</code>ï¼ˆæ¯«ç§’ï¼‰ã€‚</li>
<li><strong>é˜²é‡æ”¾</strong>ï¼šæ ¡éªŒ <code>timestamp</code> ä¸å½“å‰æ—¶é—´çš„åå·®ï¼ˆå»ºè®® â‰¤ 300 ç§’ï¼‰ï¼›ç­¾åå¿…é¡»ä½¿ç”¨<strong>åŸå§‹è¯·æ±‚ä½“</strong>ï¼ˆraw bodyï¼‰ï¼Œé¿å… JSON é‡æ’å¯¼è‡´éªŒç­¾å¤±è´¥ã€‚</li>
</ul>
<pre><code class="language-javascript">const crypto = require(&#39;crypto&#39;);
const WEBHOOK_SECRET = process.env.WEBHOOK_SECRET;

function safeEqual(a, b) {
  const bufA = Buffer.from(a);
  const bufB = Buffer.from(b);
  if (bufA.length !== bufB.length) return false;
  return crypto.timingSafeEqual(bufA, bufB);
}

function verifyWebhook(req) {
  const signature = req.headers[&#39;x-webhook-signature&#39;];
  const timestamp = req.headers[&#39;x-webhook-timestamp&#39;];
  const raw = req.rawBody || JSON.stringify(req.body); // ç¡®ä¿ä½¿ç”¨åŸå§‹è½½è·

  const base = `${timestamp}.${raw}`;
  const expected = &#39;sha256=&#39; + crypto.createHmac(&#39;sha256&#39;, WEBHOOK_SECRET).update(base).digest(&#39;hex&#39;);

  // é˜²é‡æ”¾çª—å£ï¼ˆ5åˆ†é’Ÿï¼‰
  const skew = Math.abs(Date.now() - Number(timestamp));
  if (skew &gt; 300000) return false;

  return safeEqual(expected, signature);
}
</code></pre>
<h2>é‡è¯•ç­–ç•¥å»ºè®®</h2>
<ul>
<li><strong>æŒ‡æ•°é€€é¿ + æŠ–åŠ¨</strong>ï¼šåœ¨ <code>retryInterval</code> åŸºç¡€ä¸Šå¼•å…¥æŒ‡æ•°é€€é¿ï¼ˆå¦‚ 60s â†’ 120s â†’ 240sï¼‰å¹¶åŠ å…¥éšæœºæŠ–åŠ¨ï¼Œé¿å…çªå‘æ‹¥å¡ï¼›æœ€å¤§é‡è¯•æ¬¡æ•°ç”± <code>maxRetries</code> æ§åˆ¶ã€‚</li>
<li><strong>å¹‚ç­‰æ€§</strong>ï¼šä»¥ <code>deliveryId</code> ä¸ºå¹‚ç­‰é”®ï¼Œä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼ˆDB/Redisï¼‰è®°å½•å·²å¤„ç†æŠ•é€’ï¼Œç¡®ä¿â€œè‡³å¤šä¸€æ¬¡â€ã€‚</li>
<li><strong>å“åº”çº¦å®š</strong>ï¼š<ul>
<li>ä¸šåŠ¡å¯é‡è¯•é”™è¯¯è¿”å›é 2xxï¼ˆå¦‚ 429/503ï¼‰ä»¥è§¦å‘é‡è¯•ï¼›</li>
<li>ä¸šåŠ¡é€»è¾‘é”™è¯¯ä½†ä¸éœ€é‡è¯•ï¼Œè¿”å› 200 å¹¶è®°å½•é”™è¯¯æ—¥å¿—ã€‚</li>
</ul>
</li>
</ul>
<h2>äº‹ä»¶è¿‡æ»¤æœ€ä½³å®è·µ</h2>
<ul>
<li>å°½é‡ç²¾ç¡®ï¼šé™å®š <code>docTypes</code>ã€<code>docIds</code> ä¸ <code>userIds</code>ï¼Œå‡å°‘æ— å…³æµé‡ã€‚</li>
<li>ä½¿ç”¨æ¡ä»¶åŒ¹é…ï¼šé€šè¿‡ <code>filters.conditions</code> å¯¹è½½è·è¿›è¡Œè·¯å¾„åŒ¹é…ä¸èŒƒå›´åˆ¤æ–­ï¼Œé™ä½ä¸‹æ¸¸å¤„ç†å‹åŠ›ã€‚</li>
<li>åœ¨ URL å±‚çº§è¿›è¡Œéš”ç¦»ï¼šä¸ºä¸åŒäº‹ä»¶ç±»åˆ«ä½¿ç”¨ä¸åŒçš„ Webhook æ¥æ”¶ç«¯ç‚¹ï¼Œæ–¹ä¾¿æƒé™ä¸é€Ÿç‡é™åˆ¶ã€‚</li>
</ul>

                </article>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2024 NexusBook. åŸºäº TypeSpec å®šä¹‰å¹¶ç”Ÿæˆ OpenAPI 3.0 è§„èŒƒã€‚</p>
            </div>
        </footer>
    </div>
</body>
</html>