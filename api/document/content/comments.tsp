import "@typespec/http";
import "@typespec/openapi3";
import "../../shared/index.tsp";

using TypeSpec.Http;
using OpenAPI;

/**
 * è¯„è®ºæ¨¡å—
 *
 * ç»Ÿä¸€çš„åä½œè¯„è®ºç³»ç»Ÿï¼Œæ”¯æŒåœ¨æ–‡æ¡£ä»»ä½•ä½ç½®è¿›è¡Œè¯„è®ºå’Œè®¨è®ºã€‚
 *
 * ä¸»è¦åŠŸèƒ½ï¼š
 * - **ç»Ÿä¸€è¯„è®ºç»“æ„** - å•ä¸€æ¨¡å‹æ”¯æŒæ‰€æœ‰ä½ç½®çš„è¯„è®º
 * - **ç²¾ç¡®ä½ç½®å®šä½** - ä½¿ç”¨ target å¯¹è±¡ç²¾ç¡®è®°å½•è¯„è®ºä½ç½®ï¼ˆæ–‡æ¡£/å­—æ®µ/è¡Œ/å•å…ƒæ ¼ï¼‰
 * - **è¯„è®ºå…³è”** - æ”¯æŒè¯„è®ºå›å¤å’Œè®¨è®ºæ ‘
 * - **å¯Œæ–‡æœ¬æ”¯æŒ** - æ”¯æŒæ ¼å¼åŒ–æ–‡æœ¬å’Œ @æåŠåŠŸèƒ½
 * - **é™„ä»¶ç®¡ç†** - è¯„è®ºä¸­é™„åŠ æ–‡ä»¶å’Œå›¾ç‰‡
 * - **ç½®é¡¶ç®¡ç†** - é‡è¦è¯„è®ºç½®é¡¶å±•ç¤º
 * - **ååº”è¡¨æƒ…** - æ”¯æŒè¡¨æƒ…ååº”å’Œè®¨è®ºå¢å¼º
 *
 * ## è¯„è®ºä½ç½®ç±»å‹
 *
 * ### æ–‡æ¡£çº§è¯„è®º
 * target: { scope: "document" }
 *
 * ### å­—æ®µçº§è¯„è®º
 * target: { scope: "field", fieldId: "field-123" }
 *
 * ### è¡Œçº§è¯„è®º
 * target: { scope: "row", rowId: "row-456" }
 *
 * ### å•å…ƒæ ¼çº§è¯„è®º
 * target: { scope: "cell", rowId: "row-456", fieldId: "field-123" }
 *
 * ## è¯„è®ºå›å¤æ ‘
 *
 * è¯„è®ºå¯ä»¥é€šè¿‡ parentId æŒ‡å‘å¦ä¸€æ¡è¯„è®ºï¼Œå½¢æˆè®¨è®ºçº¿ç¨‹ã€‚
 * Replies chain via parentId, forming discussion threads.
 */
namespace NexusBook.Api.Document;

/**
 * è¯„è®ºä½ç½®å®šä½å™¨
 * Comment target locator
 *
 * ç²¾ç¡®è®°å½•è¯„è®ºæ‰€åœ¨çš„ä½ç½®ã€‚æ”¯æŒå¤šå±‚çº§å®šä½ï¼šæ–‡æ¡£/å­—æ®µ/è¡Œ/å•å…ƒæ ¼ã€‚
 * Precisely records where the comment is located. Supports multi-level targeting.
 */
model CommentTarget {
    /**
     * è¯„è®ºä½œç”¨åŸŸ
     * Comment scope
     *
     * - "document" - æ–‡æ¡£çº§è¯„è®º
     * - "field" - å­—æ®µçº§è¯„è®ºï¼ˆéœ€è¦ fieldIdï¼‰
     * - "row" - è¡Œçº§è¯„è®ºï¼ˆéœ€è¦ rowIdï¼‰
     * - "cell" - å•å…ƒæ ¼è¯„è®ºï¼ˆéœ€è¦ rowId å’Œ fieldIdï¼‰
     *
     * Scope types: "document", "field", "row", "cell"
     */
    scope: string;

    /**
     * å­—æ®µIDï¼ˆå½“ scope ä¸º field æˆ– cell æ—¶ï¼‰
     * Field id (when scope is field or cell)
     */
    fieldId?: string;

    /**
     * è¡ŒIDï¼ˆå½“ scope ä¸º row æˆ– cell æ—¶ï¼‰
     * Row id (when scope is row or cell)
     */
    rowId?: string;
}

/**
 * è¡¨æƒ…ååº”
 * Emoji reaction
 */
model Reaction {
    /**
     * è¡¨æƒ…ä»£ç 
     * Emoji code (e.g., "+1", "heart", "laugh")
     */
    emoji: string;

    /**
     * ååº”äººé›†åˆ
     * Users who reacted
     */
    users: NexusBook.Api.Common.UserRef[];

    /**
     * ååº”æ•°é‡
     * Count of reactions
     */
    count: int32;
}

/**
 * ç»Ÿä¸€è¯„è®ºæ¨¡å‹
 * Unified comment model
 *
 * æ”¯æŒåœ¨æ–‡æ¡£ä»»ä½•ä½ç½®è¿›è¡Œè¯„è®ºï¼ŒåŒ…æ‹¬åµŒå¥—å›å¤ã€‚
 * Supports commenting at any location in document, including nested replies.
 */
model Comment {
    /**
     * è¯„è®ºå”¯ä¸€æ ‡è¯†
     * Unique identifier of the comment
     */
    id: string;

    /**
     * è¯„è®ºä½ç½®å®šä½
     * Comment target location
     *
     * æŒ‡å®šè¯„è®ºåœ¨æ–‡æ¡£ä¸­çš„ç¡®åˆ‡ä½ç½®ã€‚
     * Specifies the exact location of the comment in the document.
     */
    target: CommentTarget;

    /**
     * çˆ¶è¯„è®ºIDï¼ˆå¦‚æœæ˜¯å›å¤ï¼‰
     * Parent comment id (if this is a reply)
     *
     * å¦‚æœæ­¤è¯„è®ºæ˜¯å¯¹å¦ä¸€æ¡è¯„è®ºçš„å›å¤ï¼Œè®°å½•çˆ¶è¯„è®ºIDã€‚
     * If this comment is a reply to another, record the parent comment id.
     */
    parentId?: string;

    /**
     * è¯„è®ºå†…å®¹ï¼ˆæ”¯æŒå¯Œæ–‡æœ¬ï¼‰
     * Comment content (rich text supported)
     *
     * æ”¯æŒ Markdown æ ¼å¼å’Œ HTML æ ‡ç­¾ã€‚
     * Supports Markdown format and HTML tags.
     */
    content: string;

    /**
     * @æåŠç”¨æˆ·é›†åˆ
     * Mentioned users
     *
     * åœ¨è¯„è®ºä¸­è¢« @æåŠçš„ç”¨æˆ·åˆ—è¡¨ã€‚
     * List of users mentioned in the comment.
     */
    mentions?: NexusBook.Api.Common.UserRef[];

    /**
     * é™„ä»¶é›†åˆ
     * Attachments
     *
     * è¯„è®ºä¸­é™„åŠ çš„æ–‡ä»¶ã€‚
     * Files attached to the comment.
     */
    attachments?: NexusBook.Api.Common.Attachment[];

    /**
     * è¡¨æƒ…ååº”é›†åˆ
     * Emoji reactions
     *
     * å…¶ä»–ç”¨æˆ·å¯¹æ­¤è¯„è®ºçš„è¡¨æƒ…ååº”ã€‚
     * Emoji reactions from other users to this comment.
     */
    reactions?: Reaction[];

    /**
     * æ˜¯å¦å·²è§£å†³
     * Resolved flag
     *
     * æ ‡è®°æ­¤è¯„è®ºï¼ˆåŠå…¶è®¨è®ºçº¿ç¨‹ï¼‰æ˜¯å¦å·²è§£å†³ã€‚
     * Mark if this comment (and its thread) is resolved.
     */
    resolved?: boolean;

    /**
     * è§£å†³æ—¶é—´
     * Resolved at
     *
     * è¯„è®ºè§£å†³çš„æ—¶é—´æˆ³ã€‚
     * Timestamp when comment was resolved.
     */
    resolvedAt?: string;

    /**
     * è§£å†³äºº
     * Resolved by
     *
     * è§£å†³æ­¤è¯„è®ºçš„äººã€‚
     * Who resolved this comment.
     */
    resolvedBy?: NexusBook.Api.Common.UserRef;

    /**
     * æ˜¯å¦ç½®é¡¶
     * Pinned flag
     *
     * é‡è¦è¯„è®ºå¯ä»¥ç½®é¡¶å±•ç¤ºã€‚
     * Important comments can be pinned.
     */
    pinned?: boolean;

    /**
     * åˆ›å»ºæ—¶é—´
     * Created at
     */
    createdAt?: string;

    /**
     * åˆ›å»ºäºº
     * Created by
     */
    createdBy?: NexusBook.Api.Common.UserRef;

    /**
     * æ›´æ–°æ—¶é—´
     * Updated at
     */
    updatedAt?: string;

    /**
     * æ›´æ–°äºº
     * Updated by
     */
    updatedBy?: NexusBook.Api.Common.UserRef;

    /**
     * å›å¤æ•°é‡
     * Reply count
     *
     * æ­¤è¯„è®ºä¸‹çš„ç›´æ¥å›å¤æ•°ï¼ˆä¸åŒ…æ‹¬é€’å½’å›å¤ï¼‰ã€‚
     * Direct reply count to this comment (not recursive).
     */
    replyCount?: int32;
}

/**
 * ç»Ÿä¸€è¯„è®º API
 * Unified Comments API
 *
 * æ”¯æŒåœ¨æ–‡æ¡£ä»»ä½•ä½ç½®è¿›è¡Œè¯„è®ºå’Œè®¨è®ºã€‚é€šè¿‡ target å¯¹è±¡æŒ‡å®šè¯„è®ºä½ç½®ã€‚
 * Supports commenting at any location in document. Specify location via target object.
 */
@route("/doc/{docType}/{docId}/comments")
@tag("Document - Collaboration")
interface CommentsApi {
    /**
     * åˆ—å‡ºæŒ‡å®šä½ç½®çš„è¯„è®º
     *
     * List comments at specified location
     *
     * æ”¯æŒæŒ‰ä½ç½®ï¼ˆæ–‡æ¡£/å­—æ®µ/è¡Œ/å•å…ƒæ ¼ï¼‰è¿‡æ»¤è¯„è®ºã€‚
     * Supports filtering by location (document/field/row/cell).
     *
     * æŸ¥è¯¢å‚æ•°ç¤ºä¾‹:
     * - `scope=document` - æ–‡æ¡£çº§è¯„è®º
     * - `scope=field&fieldId=field-123` - æŒ‡å®šå­—æ®µçš„è¯„è®º
     * - `scope=row&rowId=row-456` - æŒ‡å®šè¡Œçš„è¯„è®º
     * - `scope=cell&rowId=row-456&fieldId=field-123` - æŒ‡å®šå•å…ƒæ ¼çš„è¯„è®º
     * - `parentId=comment-789` - æŒ‡å®šè¯„è®ºçš„å›å¤
     *
     * Query examples:
     * - `scope=document` - Document-level comments
     * - `scope=field&fieldId=field-123` - Comments on specific field
     * - `scope=row&rowId=row-456` - Comments on specific row
     * - `scope=cell&rowId=row-456&fieldId=field-123` - Comments on specific cell
     * - `parentId=comment-789` - Replies to specific comment
     */
    @get
    @summary("åˆ—å‡ºè¯„è®º")
    listComments(
        @path docType: string,
        @path docId: string,
        @query scope?: string,
        @query fieldId?: string,
        @query rowId?: string,
        @query parentId?: string,
        @query page?: int32,
        @query pageSize?: int32,
    ): NexusBook.Api.Common.ApiResponse<NexusBook.Api.Common.Page<Comment>>;

    /**
     * åˆ›å»ºæ–°è¯„è®º
     *
     * Create new comment
     *
     * åœ¨æŒ‡å®šä½ç½®åˆ›å»ºè¯„è®ºã€‚å¦‚æœæ˜¯å›å¤ï¼Œéœ€æŒ‡å®š parentIdã€‚
     * Create a comment at specified location. Specify parentId if it's a reply.
     *
     * ç¤ºä¾‹ - åˆ›å»ºæ–‡æ¡£çº§è¯„è®º (Document-level comment):
     * ```json
     * {
     *   "target": { "scope": "document" },
     *   "content": "è¿™æ˜¯ä¸€æ¡æ–‡æ¡£çº§è¯„è®º"
     * }
     * ```
     *
     * ç¤ºä¾‹ - åˆ›å»ºå•å…ƒæ ¼è¯„è®º (Cell comment):
     * ```json
     * {
     *   "target": { "scope": "cell", "rowId": "row-1", "fieldId": "name" },
     *   "content": "è¿™ä¸ªå•å…ƒæ ¼çš„æ•°æ®çœ‹èµ·æ¥ä¸å¯¹"
     * }
     * ```
     *
     * ç¤ºä¾‹ - åˆ›å»ºå›å¤ (Reply to comment):
     * ```json
     * {
     *   "target": { "scope": "cell", "rowId": "row-1", "fieldId": "name" },
     *   "parentId": "comment-original-1",
     *   "content": "æˆ‘åŒæ„ï¼Œéœ€è¦ä¿®æ­£è¿™ä¸ªæ•°æ®"
     * }
     * ```
     */
    @post
    @summary("åˆ›å»ºè¯„è®º")
    createComment(
        @path docType: string,
        @path docId: string,
        @body body: Comment,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * è·å–è¯„è®ºè¯¦æƒ…
     *
     * Get comment detail
     *
     * åŒ…æ‹¬æ‰€æœ‰å›å¤å’Œååº”ä¿¡æ¯ã€‚
     * Includes all replies and reactions.
     */
    @route("/{commentId}")
    @get
    @summary("è·å–è¯„è®ºè¯¦æƒ…")
    getComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * æ›´æ–°è¯„è®º
     *
     * Update comment
     *
     * åªæœ‰åˆ›å»ºè€…æˆ–ç®¡ç†å‘˜å¯ä»¥ç¼–è¾‘è¯„è®ºã€‚
     * Only creator or admin can edit comment.
     */
    @route("/{commentId}")
    @put
    @summary("æ›´æ–°è¯„è®º")
    updateComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
        @body body: Comment,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * åˆ é™¤è¯„è®º
     *
     * Delete comment
     *
     * åˆ é™¤è¯„è®ºä¼šåŒæ—¶åˆ é™¤å…¶æ‰€æœ‰å›å¤ã€‚
     * Deleting comment also deletes all its replies.
     */
    @route("/{commentId}")
    @delete
    @summary("åˆ é™¤è¯„è®º")
    deleteComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<unknown>;

    /**
     * ç½®é¡¶è¯„è®º
     *
     * Pin comment
     *
     * å°†è¯„è®ºç½®é¡¶ï¼Œé‡è¦è¯„è®ºå¯ä»¥å›ºå®šåœ¨é¡¶éƒ¨ã€‚
     * Pin important comments to the top.
     */
    @route("/{commentId}/pin")
    @post
    @summary("ç½®é¡¶è¯„è®º")
    pinComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * å–æ¶ˆç½®é¡¶
     *
     * Unpin comment
     */
    @route("/{commentId}/unpin")
    @post
    @summary("å–æ¶ˆç½®é¡¶")
    unpinComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * æ ‡è®°ä¸ºå·²è§£å†³
     *
     * Mark comment as resolved
     *
     * æ ‡è®°è¯„è®ºåŠå…¶è®¨è®ºçº¿ç¨‹ä¸ºå·²è§£å†³ã€‚
     * Mark comment and its discussion thread as resolved.
     */
    @route("/{commentId}/resolve")
    @post
    @summary("æ ‡è®°å·²è§£å†³")
    resolveComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * å–æ¶ˆè§£å†³æ ‡è®°
     *
     * Unresolved comment
     */
    @route("/{commentId}/unresolve")
    @post
    @summary("å–æ¶ˆå·²è§£å†³æ ‡è®°")
    unresolveComment(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * æ·»åŠ è¡¨æƒ…ååº”
     *
     * Add emoji reaction
     *
     * åœ¨è¯„è®ºä¸Šæ·»åŠ è¡¨æƒ…ååº”ï¼ˆå¦‚ ğŸ‘ã€â¤ï¸ ç­‰ï¼‰ã€‚
     * Add emoji reaction to comment (e.g. ğŸ‘, â¤ï¸).
     */
    @route("/{commentId}/reactions")
    @post
    @summary("æ·»åŠ è¡¨æƒ…ååº”")
    addReaction(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
        @query emoji: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;

    /**
     * ç§»é™¤è¡¨æƒ…ååº”
     *
     * Remove emoji reaction
     */
    @route("/{commentId}/reactions/{emoji}")
    @delete
    @summary("ç§»é™¤è¡¨æƒ…ååº”")
    removeReaction(
        @path docType: string,
        @path docId: string,
        @path commentId: string,
        @path emoji: string,
    ): NexusBook.Api.Common.ApiResponse<Comment>;
}
